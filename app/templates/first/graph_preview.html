{% macro content() %}
    <div class="space-y-6">
        <div class="bg-secondary text-secondary-content rounded-lg p-4">
            <h3 class="mb-2 text-xl font-bold">
                Graph Preview: {{ job.uploaded_file.original_filename }}
            </h3>
            <div class="grid grid-cols-2 gap-4 text-sm md:grid-cols-4">
                <div>
                    <span class="badge badge-success">{{ job.status }}</span>
                </div>
                <div>
                    <span class="font-semibold">{{ job.final_nodes }}</span>
                    Nodes
                </div>
                <div>
                    <span class="font-semibold"> {{ job.final_edges }} </span>
                    <span class="">edges</span>
                </div>
                <div>
                    <span class="font-semibold">{{ job.time_periods }}</span>
                    Time Periods
                </div>
            </div>
        </div>

        {% if edges_preview %}
            <div>
                <h4 class="mb-2 text-lg font-semibold">
                    Edge Preview (First 20)
                </h4>
                <div class="overflow-x-auto">
                    <table class="table-sm table-zebra table">
                        <thead>
                            <tr>
                                <th>Source Playlist</th>
                                <th>Target Playlist</th>
                                <th>Weight</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for edge in edges_preview %}
                                <tr>
                                    <td class="font-mono text-xs">
                                        {{ edge['playlist_id_1'] }}
                                    </td>
                                    <td class="font-mono text-xs">
                                        {{ edge['playlist_id_2'] }}
                                    </td>
                                    <td>{{ edge['weight'] }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% endif %}

        {% if nodes_preview %}
            <div>
                <h4 class="mb-2 text-lg font-semibold">
                    Node Preview (First 20)
                </h4>
                <div class="overflow-x-auto">
                    <table class="table-sm table-zebra table">
                        <thead>
                            <tr>
                                <th>Playlist ID</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for node in nodes_preview %}
                                <tr>
                                    <td class="font-mono text-xs">
                                        {{ node['playlist_id'] }}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% endif %}

        <div class="mt-4">
            <h4 class="mb-4 text-lg font-semibold">
                Interactive Graph Visualization
            </h4>
            <div
                id="graph-container"
                class="bg-base-100 relative rounded-lg"
                style="height: 600px;">
                <div class="skeleton h-full w-full"></div>
            </div>

            <!-- Graph info panel -->
            <div
                id="graph-info-panel"
                class="card bg-base-300 absolute bottom-4 left-4 z-20 mb-4 w-80 opacity-95 shadow-xl ring-1 ring-white/15 backdrop-blur-lg"
                style="display: none">
                <div class="card-body p-4">
                    <h5
                        id="node-name"
                        class="card-title text-sm"></h5>
                    <div
                        id="node-info"
                        class="space-y-2 text-xs">
                        <div id="node-description"></div>
                        <div id="node-followers"></div>
                        <div id="node-incoming"></div>
                        <div id="node-outgoing"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script type="module">
        // Function to load D3 if not already loaded
        function loadD3() {
            return new Promise((resolve, reject) => {
                if (typeof d3 !== 'undefined') {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/d3@7';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        // Initialize graph after D3 is loaded
        async function initializeGraph() {
            await loadD3();
            
            // Graph visualization adapted from graph.html
            const jobId = "{{ job.uuid }}";
            const graphContainer = d3.select("#graph-container");
            const containerRect = document
                .getElementById("graph-container")
                .getBoundingClientRect();
            const width = containerRect.width;
            const height = 600;

            let nodes, links;
            let linkCount = {};
            let IncomingCount = {};
            let OutgoingCount = {};

            function fillTooltip(data, incoming = 0, outgoing = 0) {
                const panel = d3.select("#graph-info-panel");
                panel.style("display", "block");

                panel
                    .select("#node-name")
                    .text(data.display_name || data.playlist_id);
                panel
                    .select("#node-description")
                    .text(`Description: ${data.playlist_description || "none"}`);
                panel
                    .select("#node-followers")
                    .text(`${data.playlist_followers || 0} followers`);
                panel
                    .select("#node-incoming")
                    .text(`${incoming} incoming connections`);
                panel
                    .select("#node-outgoing")
                    .text(`${outgoing} outgoing connections`);
            }

            Promise.all([
                d3.json(`{{ url_for('first.graph_nodes_data', job_id=job.uuid) }}`),
                d3.json(`{{ url_for('first.graph_edges_data', job_id=job.uuid) }}`),
            ])
                .then((data) => {
                nodes = data[0];
                links = data[1];

                // Transform links data
                links = links.map((d) => ({
                    source: d.playlist_id_1,
                    target: d.playlist_id_2,
                    weight: d.weight,
                }));

                // Calculate link counts
                links.forEach((link) => {
                    linkCount[link.source] = (linkCount[link.source] || 0) + 1;
                    linkCount[link.target] = (linkCount[link.target] || 0) + 1;
                    IncomingCount[link.target] =
                        (IncomingCount[link.target] || 0) + 1;
                    OutgoingCount[link.source] =
                        (OutgoingCount[link.source] || 0) + 1;
                });

                // Remove duplicate links
                links = links.filter(
                    (v, i, a) =>
                        a.findIndex(
                            (t) =>
                                t.source === v.source && t.target === v.target
                        ) === i
                );

                // Initialize node positions
                nodes = nodes.map((d) => ({
                    ...d,
                    x: Math.random() * width,
                    y: Math.random() * height,
                }));

                // Clear skeleton loader
                graphContainer.selectAll("*").remove();

                // Create SVG
                const svg = graphContainer
                    .append("svg")
                    .attr("width", width)
                    .attr("height", height);

                // Define zoom behavior
                const zoom = d3
                    .zoom()
                    .scaleExtent([0.2, 10])
                    .on("zoom", zoomed);

                svg.call(zoom);

                function nodeSize(d) {
                    return Math.sqrt(OutgoingCount[d.playlist_id] || 1) * 4;
                }

                function zoomed(event) {
                    const transform = event.transform;
                    node.attr("transform", transform);
                    link.attr("transform", transform);
                }

                // Add definitions for markers and gradients
                const defs = svg.append("defs");

                defs.selectAll("marker")
                    .data(["end"])
                    .enter()
                    .append("marker")
                    .attr("id", String)
                    .attr("viewBox", "0 -5 10 10")
                    .attr("refX", 15)
                    .attr("refY", -1.5)
                    .attr("markerWidth", 6)
                    .attr("markerHeight", 6)
                    .attr("orient", "auto")
                    .append("svg:path")
                    .attr("d", "M0,-5L10,0L0,5")
                    .attr("class", "fill-current");

                const gradient = defs
                    .append("radialGradient")
                    .attr("id", "gradient")
                    .attr("cx", "50%")
                    .attr("cy", "50%")
                    .attr("r", "50%");

                gradient
                    .append("stop")
                    .attr("offset", "0%")
                    .attr("stop-color", "#1ED760")
                    .attr("stop-opacity", 1);
                gradient
                    .append("stop")
                    .attr("offset", "100%")
                    .attr("stop-color", "#128C46")
                    .attr("stop-opacity", 1);

                function linkOpacity(d) {
                    return Math.min(d.weight / 64, 0.8);
                }

                // Create simulation
                const simulation = d3
                    .forceSimulation(nodes)
                    .force(
                        "link",
                        d3
                            .forceLink(links)
                            .id((d) => d.playlist_id)
                            .distance(80)
                    )
                    .force(
                        "collide",
                        d3.forceCollide().radius((d) => nodeSize(d))
                    )
                    .force("charge", d3.forceManyBody().strength(-60))
                    .force(
                        "center",
                        d3.forceCenter(width / 2, height / 2).strength(0.2)
                    )
                    .on("tick", ticked);

                // Create links
                const link = svg
                    .selectAll("line")
                    .data(links)
                    .enter()
                    .append("line")
                    .attr("class", "stroke-current")
                    .attr("opacity", (d) => linkOpacity(d))
                    .attr("marker-end", "url(#end)");

                // Node event handlers
                function selectNode(event, d, node) {
                    fillTooltip(
                        d,
                        IncomingCount[d.playlist_id],
                        OutgoingCount[d.playlist_id]
                    );

                    d3.select(node)
                        .transition()
                        .duration(200)
                        .attr("r", (d) => nodeSize(d) + 5);
                }

                function deselectNode(event, d, node) {
                    d3.select(node)
                        .transition()
                        .duration(200)
                        .attr("r", (d) => nodeSize(d));
                }

                function highlightNeighbors(event, d, node) {
                    const neighbors = links
                        .filter(
                            (link) => link.source === d || link.target === d
                        )
                        .map((link) =>
                            link.source.playlist_id === d.playlist_id
                                ? link.target
                                : link.source
                        );

                    const neighborsLinks = links.filter(
                        (link) => link.source === d || link.target === d
                    );

                    d3.selectAll("circle").attr("opacity", 0.3);
                    d3.selectAll("line")
                        .filter((d) => !neighborsLinks.includes(d))
                        .transition()
                        .duration(300)
                        .ease(d3.easeCubicInOut)
                        .attr("opacity", 0.05);

                    d3.selectAll("line")
                        .filter((d) => neighborsLinks.includes(d))
                        .transition()
                        .duration(300)
                        .ease(d3.easeCubicInOut)
                        .attr("opacity", (d) => linkOpacity(d));

                    d3.selectAll("circle")
                        .filter((d) => neighbors.includes(d))
                        .attr("opacity", 1);

                    d3.select(node).attr("opacity", 1);
                }

                // Create nodes
                const node = svg
                    .selectAll("circle")
                    .data(nodes)
                    .enter()
                    .append("circle")
                    .attr("r", (d) => nodeSize(d))
                    .attr("fill", "url(#gradient)")
                    .call(drag(simulation))
                    .on("mouseover", function (event, d) {
                        selectNode(event, d, this);
                    })
                    .on("mouseout", function (event, d) {
                        deselectNode(event, d, this);
                    })
                    .on("click", function (event, d) {
                        highlightNeighbors(event, d, this);
                    })
                    .on("reset", function () {
                        d3.selectAll("circle").attr("opacity", 1);
                        d3.selectAll("line").attr("opacity", (d) =>
                            linkOpacity(d)
                        );
                    });

                // Reset on background click
                svg.on("click", function (event) {
                    if (event.target.tagName !== "circle") {
                        d3.selectAll("circle").dispatch("reset");
                        d3.select("#graph-info-panel").style("display", "none");
                    }
                });

                function drag(simulation) {
                    function dragstarted(event) {
                        if (!event.active)
                            simulation.alphaTarget(0.3).restart();
                        event.subject.fx = event.subject.x;
                        event.subject.fy = event.subject.y;
                    }

                    function dragged(event) {
                        event.subject.fx = event.x;
                        event.subject.fy = event.y;
                    }

                    function dragended(event) {
                        if (!event.active) simulation.alphaTarget(0);
                        event.subject.fx = null;
                        event.subject.fy = null;
                    }

                    return d3
                        .drag()
                        .on("start", dragstarted)
                        .on("drag", dragged)
                        .on("end", dragended);
                }

                function ticked() {
                    link.attr("x1", (d) => d.source.x)
                        .attr("y1", (d) => d.source.y)
                        .attr("x2", (d) => d.target.x)
                        .attr("y2", (d) => d.target.y);

                    node.attr("cx", (d) => d.x).attr("cy", (d) => d.y);
                }
                })
                .catch((error) => {
                    console.error("Error loading graph data:", error);
                    graphContainer.selectAll("*").remove();
                    graphContainer
                        .append("div")
                        .attr(
                            "class",
                            "flex items-center justify-center h-full text-error"
                        )
                        .text("Error loading graph data");
                });
        }
        
        // Initialize the graph when the page loads or when navigating via HTMX
        initializeGraph();
    </script>
{% endmacro %}

{% if htmx.boosted %}
    <title>{{ title }}</title>

    <div
        id="top-bar"
        hx-swap-oob="innerHTML">
        {% block top_bar %}
            <div class="container flex w-full items-center justify-between">
                <a
                    href="javascript:history.back()"
                    class="group hover:text-primary flex items-center gap-1 transition-colors">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        class="size-4 stroke-current stroke-2 transition-transform duration-300 ease-out group-hover:-translate-x-1">
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
                    </svg>
                    <span>back</span>
                </a>
            </div>
        {% endblock %}
    </div>
    {{ content() }}
{% else %}
    {% extends 'base.html' %}
    {% block content %}
        {{ content() }}
    {% endblock %}
{% endif %}
